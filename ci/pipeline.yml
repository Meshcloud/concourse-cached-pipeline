---
resource_types:
- name: git-branch-heads
  type: docker-image
  source:
    repository: vito/git-branch-heads-resource

- name: rsync-resource
  type: docker-image
  source:
      repository: mrsixw/concourse-rsync-resource
      tag: latest

resources:
# Repos
- name: github-master
  type: git
  source: &github-master # YAML anchor ;-)
    uri: https://github.com/Meshcloud/concourse-cached-pipeline.git
    branch: master

- name: rsync-cache
  type: rsync-resource
  source:
    server: ci.dev.meshcloud.io
    base_dir: /ccp-cache
    user : www
    private_key: {{artifacts-private-key}}
    disable_version_path: true

jobs:
- name: build-master
  plan:

  - get: repo
    resource: github-master
    trigger: true
  - aggregate:
    - task: cache-a
      file: repo/ci/cache-a.yml
      output_mapping:
        cache: cache-a
    - task: cache-b
      file: repo/ci/cache-b.yml
      output_mapping:
        cache: cache-b
  - put: rsync-cache
    params: {"sync_dir" : "cache-a" }
  - task: build
    file: repo/ci/build.yml  